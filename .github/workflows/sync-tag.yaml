name: sync tags

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:  
      inputs:
        ssh:
          description: 'ÊòØÂê¶ÂºÄÂêØsshË∞ÉËØï'
          required: true
          default: 'false'
          type: choice
          options:
            - 'true'
            - 'false'

jobs:
  sync-and-patch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: actions
          persist-credentials: false
          
      - name: copy patch file
        run: |
          cp fingerprint.patch ../
          cp .github/workflows/build.yaml ../

      - name: record lastest tag
        run: |
          echo "export lastest_tag=$(curl -s https://api.github.com/repos/codetiger666/openwrt/tags?per_page=1 | jq -r '.[0].name')" >> $HOME/.profile
          echo "export openwrt_lastest_tag=$(curl -s https://api.github.com/repos/openwrt/openwrt/tags?per_page=1 | jq -r '.[0].name')" >> $HOME/.profile

      - name: init git
        run: |
          git config --global user.email ${{ secrets.email }}
          git config --global user.name "codetiger666"
          git config --global pull.rebase true

      - name: Add upstream repository
        run: |
          source $HOME/.profile
          if [ "$openwrt_lastest_tag" != "$lastest_tag" ]; then
            git clone -b $openwrt_lastest_tag https://github.com/openwrt/openwrt.git
            cd openwrt
            git checkout -b ${openwrt_lastest_tag/v} $openwrt_lastest_tag
            git remote add codetiger https://${{ secrets.ACCESS_TOKEN }}@github.com/codetiger666/openwrt.git
            git am ../fingerprint.patch
            rm -rf .github/workflows/*
            cp ../../build.yaml .github/workflows
            git add . || true
            git commit -m "add action for build" || true
            git tag -d $openwrt_lastest_tag
            git tag $openwrt_lastest_tag
            git push codetiger $openwrt_lastest_tag -f
          fi
          
      - name: SSH connection to Actions
        uses: P3TERX/ssh2actions@main
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false')

      - name: Apply patch and retag
        run: |
          source $HOME/.profile
          echo "Processing tag: $openwrt_lastest_tag"
          echo "lastest tag: $lastest_tag"
          echo "Ëß¶ÂèëÁºñËØë"
          if [ "$openwrt_lastest_tag" != "$lastest_tag" ]; then
            curl -v -X POST \
            https://api.github.com/repos/codetiger666/openwrt/actions/workflows/build.yaml/dispatches \
            -H "Authorization: Bearer ${{ secrets.ACCESS_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{\"ref\":\"${openwrt_lastest_tag}\",\"inputs\":{\"ssh\":\"false\"}}"
            version=${openwrt_lastest_tag/openwrt-}
            version=${version//./\\\\.}
            curl -X POST \
                --url https://api.telegram.org/bot${{ secrets.TG_BOT_KEY }}/sendMessage \
                --header 'Accept: */*' \
                --header 'Accept-Encoding: gzip, deflate, br' \
                --header 'Connection: keep-alive' \
                --header 'Content-Type: application/json' \
                --data "{
                \"chat_id\": \"${{ secrets.TG_BOT_USER_ID }}\",
                \"text\": \"\\\\[openwrt\\\\] \\\\[üü¢ Ëß¶ÂèëÁºñËØë\\\\]\nÁâàÊú¨:\`$version\`\",
                \"parse_mode\": \"MarkdownV2\",
                \"reply_markup\": {
                  \"inline_keyboard\": [
                      [
                          {
                            \"text\": \"${tag/v}Êõ¥Êñ∞Êó•Âøó\",
                            \"url\": \"https://github.com/openwrt/openwrt/releases/tag/$tag\"
                          }
                      ]
                  ]
                }
                }"
          fi
